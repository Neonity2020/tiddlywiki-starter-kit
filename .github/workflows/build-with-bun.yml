name: Deploy to GitHub Pages

on:
  # 每次推送到 `main` 分支时触发这个“工作流程”
  # 如果你使用了别的分支名，请按需将 `main` 替换成你的分支名
  push:
    branches: [main]
  # 允许你在 GitHub 上的 Actions 标签中手动触发此“工作流程”
  workflow_dispatch:

# 允许 job 克隆 repo 并创建一个 page deployment
permissions:
  contents: write
  pages: write
  # id-token: write

jobs:
  release-and-page:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependency
        run: bun install # --production

      - name: Build Page
        run: bun run build

      # - name: Build PDF
      #   uses: baileyjm02/markdown-to-pdf@v1
      #   with:
      #     input_dir: ./.tiddlywiki/markdown
      #     output_dir: pdfs
      #     build_html: false


      # - name: Upload
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: docs
      #     path: pdfs

      - name: create file list
        id: files_list
        run: |
          mkdir output  # create output dir
          # this will also include README.md
          echo "files=$(printf '"%s" ' ./.tiddlywiki/markdown/JavaScript/a*.md)" > $GITHUB_OUTPUT

      - uses: docker://pandoc/latex:2.9
        with:
          args: --output=output/result.pdf ${{ steps.files_list.outputs.files }} --pdf-engine=xelatex -V geometry:'top=2cm, bottom=1.5cm, left=2cm,right=2cm' --toc -N  --highlight-style kate  -V urlcolor=NavyBlue -f markdown-raw_tex --template='templates/temp.latex'
          #  -V CJKmainfont="KaiTi"

      - uses: actions/upload-artifact@v3
        with:
          name: output
          path: output

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: |
            ./.tiddlywiki
